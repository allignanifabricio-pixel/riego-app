<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Riego App</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2e7d32">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Arial}

body{
  background:#f2f2f2;
  color:#333;
  transition:0.3s;
}

header{
  background:#2e7d32;
  color:white;
  padding:15px;
  text-align:center;
  font-size:18px;
  position:sticky;
  top:0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

header button{
  background:none;
  border:none;
  color:white;
  font-size:18px;
}

.week-bar{
  display:flex;
  overflow:hidden;
  background:white;
  padding:10px 5px;
  gap:6px;
}

.day-pill{
  flex:1;
  text-align:center;
  padding:8px 4px;
  border-radius:12px;
  font-size:12px;
  background:#e0e0e0;
}

.day-pill.active{
  background:#2e7d32;
  color:white;
  font-weight:bold;
}

.container{
  padding:15px;
}

.tree-card{
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
  color:white;
}

.tree-card h3{
  margin-bottom:8px;
}

.actions{
  margin-top:10px;
  display:flex;
  gap:10px;
}

.actions button{
  flex:1;
  border:none;
  padding:8px;
  border-radius:10px;
  font-size:12px;
}

.edit{background:#ffc107}
.delete{background:#f44336;color:white}

.fab{
  position:fixed;
  bottom:20px;
  right:20px;
  width:55px;
  height:55px;
  border-radius:50%;
  border:none;
  font-size:28px;
  color:white;
  background:#2e7d32;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal-content{
  background:white;
  padding:20px;
  border-radius:15px;
  width:90%;
}

.modal-content input,select{
  width:100%;
  padding:10px;
  margin-bottom:10px;
}

.modal-content button{
  width:100%;
  padding:10px;
  background:#2e7d32;
  color:white;
  border:none;
  border-radius:10px;
}

/* MODO OSCURO */
.dark{
  background:#121212;
  color:white;
}

.dark .week-bar{
  background:#1e1e1e;
}

.dark .day-pill{
  background:#333;
  color:white;
}

.dark .modal-content{
  background:#1e1e1e;
  color:white;
}
</style>
</head>
<body>

<header>
  Cuidado de √Årboles
  <button onclick="toggleDark()">üåô</button>
</header>

<div class="week-bar" id="weekBar"></div>
<div class="container" id="treeContainer"></div>

<button class="fab" onclick="openModal()">+</button>

<div class="modal" id="modal">
  <div class="modal-content">
    <input type="text" id="nombre" placeholder="Nombre del √°rbol">
    <input type="number" id="frecuencia" placeholder="Cada cu√°ntos d√≠as">
    <select id="icono">
      <option value="üå≥">üå≥ √Årbol</option>
      <option value="üå¥">üå¥ Palmera</option>
      <option value="üå≤">üå≤ Pino</option>
      <option value="üå±">üå± Planta</option>
    </select>
    <button onclick="guardar()">Guardar</button>
  </div>
</div>

<script>
let arboles=JSON.parse(localStorage.getItem("arboles"))||[];
let selectedDate=formatDate(new Date());
let semanaOffset=0;
let editando=null;

const diasSemana=["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];

/* -------- FECHAS SEGURAS (SIN UTC) -------- */

function parseLocalDate(str){
  const [y,m,d]=str.split("-").map(Number);
  return new Date(y,m-1,d);
}

function formatDate(date){
  const y=date.getFullYear();
  const m=("0"+(date.getMonth()+1)).slice(-2);
  const d=("0"+date.getDate()).slice(-2);
  return `${y}-${m}-${d}`;
}

/* ----------------------------------------- */

function getMonday(d){
  d=new Date(d);
  const day=d.getDay()||7;
  if(day!==1)d.setDate(d.getDate()-day+1);
  return d;
}

function renderWeek(){
  const weekBar=document.getElementById("weekBar");
  weekBar.innerHTML="";
  const base=parseLocalDate(formatDate(new Date()));
  base.setDate(base.getDate()+semanaOffset*7);
  const monday=getMonday(base);

  for(let i=0;i<7;i++){
    const d=new Date(monday);
    d.setDate(monday.getDate()+i);
    const fechaStr=formatDate(d);

    const dia=("0"+d.getDate()).slice(-2);
    const mes=("0"+(d.getMonth()+1)).slice(-2);

    const div=document.createElement("div");
    div.className="day-pill";
    if(fechaStr===selectedDate) div.classList.add("active");

    div.innerHTML=`${diasSemana[i]}<br>${dia}/${mes}`;

    div.onclick=()=>{
      selectedDate=fechaStr;
      render();
    };

    weekBar.appendChild(div);
  }
}

function corresponde(arbol,fecha){
  const inicio=parseLocalDate(arbol.fechaInicio);
  const actual=parseLocalDate(fecha);
  const diff=Math.floor((actual-inicio)/(1000*60*60*24));
  return diff>=0 && diff%arbol.frecuencia===0;
}

function renderTrees(){
  const container=document.getElementById("treeContainer");
  container.innerHTML="";
  const lista=arboles.filter(a=>corresponde(a,selectedDate));

  if(lista.length===0){
    container.innerHTML="<p style='text-align:center;'>No hay riegos este d√≠a</p>";
    return;
  }

  lista.forEach(a=>{
    const card=document.createElement("div");
    card.className="tree-card";

    const colores=[
      "linear-gradient(135deg,#2e7d32,#43a047)",
      "linear-gradient(135deg,#1565c0,#42a5f5)",
      "linear-gradient(135deg,#ef6c00,#ffa726)"
    ];
    card.style.background=colores[Math.floor(Math.random()*colores.length)];

    const fechaActual=parseLocalDate(selectedDate);
    const inicio=parseLocalDate(a.fechaInicio);

    const diff=Math.floor((fechaActual-inicio)/(1000*60*60*24));
    const diasDesdeUltimo=diff%a.frecuencia;

    let diasParaProximo=a.frecuencia-diasDesdeUltimo;
    if(diasParaProximo===0){
      diasParaProximo=a.frecuencia;
    }

    const proximo=new Date(fechaActual);
    proximo.setDate(fechaActual.getDate()+diasParaProximo);

    const dia=("0"+proximo.getDate()).slice(-2);
    const mes=("0"+(proximo.getMonth()+1)).slice(-2);

    card.innerHTML=`
      <h3>${a.icono} ${a.nombre}</h3>
      <p>
        Regar cada ${a.frecuencia} d√≠as<br>
        Pr√≥ximo riego: ${dia}/${mes}
      </p>
      <div class="actions">
        <button class="edit" onclick="editar(${a.id})">Editar</button>
        <button class="delete" onclick="borrar(${a.id})">Borrar</button>
      </div>
    `;
    container.appendChild(card);
  });
}

function render(){
  renderWeek();
  renderTrees();
}

function openModal(){
  document.getElementById("modal").style.display="flex";
  document.getElementById("nombre").value="";
  document.getElementById("frecuencia").value="";
  editando=null;
}

function guardar(){
  const nombre=document.getElementById("nombre").value;
  const frecuencia=parseInt(document.getElementById("frecuencia").value);
  const icono=document.getElementById("icono").value;

  if(!nombre||!frecuencia)return;

  if(editando){
    editando.nombre=nombre;
    editando.frecuencia=frecuencia;
    editando.icono=icono;
  }else{
    arboles.push({
      id:Date.now(),
      nombre,
      frecuencia,
      icono,
      fechaInicio:selectedDate
    });
  }

  localStorage.setItem("arboles",JSON.stringify(arboles));
  document.getElementById("modal").style.display="none";
  render();
}

function editar(id){
  const a=arboles.find(x=>x.id===id);
  if(!a)return;
  editando=a;
  document.getElementById("nombre").value=a.nombre;
  document.getElementById("frecuencia").value=a.frecuencia;
  document.getElementById("icono").value=a.icono;
  document.getElementById("modal").style.display="flex";
}

function borrar(id){
  arboles=arboles.filter(a=>a.id!==id);
  localStorage.setItem("arboles",JSON.stringify(arboles));
  render();
}

function toggleDark(){
  document.body.classList.toggle("dark");
}

/* DESLIZAR SEMANA */
let startX=0;
document.addEventListener("touchstart",e=>{
  startX=e.touches[0].clientX;
});

document.addEventListener("touchend",e=>{
  let endX=e.changedTouches[0].clientX;
  if(endX-startX>50){
    semanaOffset--;
    render();
  }else if(startX-endX>50){
    semanaOffset++;
    render();
  }
});

render();
</script>

</body>
</html>